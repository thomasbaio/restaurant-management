<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Modifica Profilo</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <h1>Modifica Profilo Utente</h1>

  <form id="edit-user-form">
    <label>Username: <input type="text" id="username" required></label><br><br>
    <label>Email: <input type="email" id="email" required></label><br><br>
    <label>Password: <input type="password" id="password" required></label><br><br>

    <label>Ruolo:</label><br>
    <label><input type="radio" name="role" value="cliente"> Cliente</label><br>
    <label><input type="radio" name="role" value="ristoratore"> Ristoratore</label><br><br>

    <div id="ristoratore-extra" style="display: none;">
      <label>Partita IVA: <input type="text" id="piva"></label><br><br>
      <label>Telefono: <input type="text" id="telefono"></label><br><br>
      <label>Luogo: <input type="text" id="luogo"></label><br><br>
      <label>Via: <input type="text" id="via"></label><br><br>
    </div>

    <div id="cliente-extra" style="display: none;">
      <label>Nome: <input type="text" id="nome"></label><br><br>
      <label>Cognome: <input type="text" id="cognome"></label><br><br>
      <label>Metodo di Pagamento:
        <select id="pagamento">
          <option value="">-- Seleziona --</option>
          <option value="Visa">Visa</option>
          <option value="Mastercard">Mastercard</option>
          <option value="Postepay">Postepay</option>
          <option value="Amex">Amex</option>
        </select>
      </label><br><br>
      <label>Preferenza prodotto:
        <select id="preferenza">
          <option value="">-- Nessuna --</option>
          <option value="primi">Primi</option>
          <option value="secondi">Secondi</option>
          <option value="Dessert">Dessert</option>
          <option value="Offerte speciali">offerte speciali</option>
          <option value="bevande">Bevande</option>
        </select>
      </label><br><br>
    </div>

    <button type="submit">Salva Modifiche</button>
    <button type="button" id="delete-btn" style="color: red;">Elimina Profilo</button>
  </form>

  <p><a href="index.html">Torna alla Home</a></p>

  <script>
    // ---- Config dinamica API ----
    const isLocal =
      location.hostname === "localhost" ||
      location.hostname === "127.0.0.1";
    const API_BASE = isLocal
      ? "http://localhost:3000"
      : "https://restaurant-management-wzhj.onrender.com";

    // ---- User e ID sicuri ----
    const params = new URLSearchParams(window.location.search);
    const storedUser = JSON.parse(localStorage.getItem("loggedUser") || "null");

    if (!storedUser) {
      alert("Devi essere loggato per modificare il profilo");
      window.location.href = "login.html";
    }

    // id può arrivare dal localStorage oppure da ?id= (fallback)
    const userIdFromQuery = params.get("id");
    const userId =
      (storedUser && storedUser.id != null ? storedUser.id : null) ??
      (userIdFromQuery ? parseInt(userIdFromQuery) : null);

    if (userId == null || Number.isNaN(userId)) {
      alert("Impossibile determinare l'ID utente. Effettua di nuovo il login.");
      window.location.href = "login.html";
    }

    const user = { ...storedUser, id: userId };

    // ---- Prefill form ----
    function showRoleBlocks(role) {
      document.getElementById("ristoratore-extra").style.display =
        role === "ristoratore" ? "block" : "none";
      document.getElementById("cliente-extra").style.display =
        role === "cliente" ? "block" : "none";
    }

    function safeSet(id, val) {
      const el = document.getElementById(id);
      if (el) el.value = val ?? "";
    }

    // Precompila campi base
    safeSet("username", user.username);
    safeSet("email", user.email);
    safeSet("password", user.password);

    const role = user.role === "ristoratore" || user.role === "cliente" ? user.role : "cliente";
    const roleInput = document.querySelector(`input[name="role"][value="${role}"]`);
    if (roleInput) roleInput.checked = true;
    showRoleBlocks(role);

    // Ristoratore extra
    safeSet("piva", user.piva);
    safeSet("telefono", user.telefono);
    safeSet("luogo", user.luogo);
    safeSet("via", user.via);

    // Cliente extra
    safeSet("nome", user.nome);
    safeSet("cognome", user.cognome);
    safeSet("pagamento", user.pagamento);
    safeSet("preferenza", user.preferenza);

    // Toggle dinamico al cambio ruolo
    document.querySelectorAll('input[name="role"]').forEach(radio => {
      radio.addEventListener("change", function () {
        showRoleBlocks(this.value);
      });
    });

    // ---- Submit Modifica ----
    document.getElementById("edit-user-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const selectedRole = document.querySelector('input[name="role"]:checked')?.value || "cliente";

      const updatedUser = {
        username: document.getElementById("username").value.trim(),
        email: document.getElementById("email").value.trim(),
        password: document.getElementById("password").value,
        role: selectedRole
      };

      if (updatedUser.role === "ristoratore") {
        updatedUser.piva = document.getElementById("piva").value.trim();
        updatedUser.telefono = document.getElementById("telefono").value.trim();
        updatedUser.luogo = document.getElementById("luogo").value.trim();
        updatedUser.via = document.getElementById("via").value.trim();
      } else {
        updatedUser.nome = document.getElementById("nome").value.trim();
        updatedUser.cognome = document.getElementById("cognome").value.trim();
        updatedUser.pagamento = document.getElementById("pagamento").value;
        updatedUser.preferenza = document.getElementById("preferenza").value;
      }

      try {
        const res = await fetch(`${API_BASE}/users/${user.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedUser)
        });

        if (res.ok) {
          // Tieni l'id esistente; se il backend restituisce l'oggetto aggiornato, usalo
          let saved = null;
          try { saved = await res.json(); } catch { /* può restituire vuoto */ }
          const finalUser = saved && typeof saved === "object" ? saved : { ...updatedUser, id: user.id };
          localStorage.setItem("loggedUser", JSON.stringify(finalUser));
          alert("Profilo aggiornato con successo!");
          window.location.href = "index.html";
        } else {
          const msg = await res.text();
          alert("Errore durante la modifica del profilo: " + (msg || res.status));
        }
      } catch (err) {
        console.error("Errore:", err);
        alert("Errore di rete. Verifica la connessione o l'URL del server.");
      }
    });

    // ---- Delete account ----
    document.getElementById("delete-btn").addEventListener("click", async function () {
      if (!confirm("Sei sicuro di voler cancellare il tuo account?")) return;

      try {
        const res = await fetch(`${API_BASE}/users/${user.id}`, { method: "DELETE" });

        if (res.ok) {
          alert("Account eliminato");
          localStorage.removeItem("loggedUser");
          window.location.href = "index.html";
        } else {
          const msg = await res.text();
          alert("Errore nella cancellazione dell’account: " + (msg || res.status));
        }
      } catch (err) {
        console.error("Errore:", err);
        alert("Errore di rete. Verifica la connessione o l'URL del server.");
      }
    });
  </script>
</body>
</html>
