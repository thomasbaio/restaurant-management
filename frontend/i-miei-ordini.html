<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>I miei ordini</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .ordine-box { border:1px solid #ddd; border-radius:10px; padding:12px; margin:10px 0; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:.85rem; }
    .badge.ordinato{ background:#eef; }
    .badge.preparazione{ background:#ffe9b3; }
    .badge.ritirato{ background:#c7f9cc; }
    .badge.annullato{ background:#ffd6d6; }
    .azioni button{ margin-right:8px; }
    .muted { color:#666; }
    .success { background:#e8ffe8; border:1px solid #b6e3b6; padding:8px 10px; border-radius:8px; }
  </style>
</head>
<body>
  <h1>üì¶ I miei ordini</h1>

  <div id="noti"></div>
  <div id="ordini-container">
    <p>Caricamento in corso...</p>
  </div>

  <p><a href="index.html">‚¨ÖÔ∏è Torna alla home</a></p>
  <p><a href="storico_clienti.html">vecchi ordini</a></p>

  <script src="js/main.js" defer></script>

  <!-- Fallback API_BASE -->
  <script>
    (function () {
      if (!window.API_BASE) {
        const isLocal = ["localhost","127.0.0.1"].includes(location.hostname);
        window.API_BASE = isLocal ? "http://localhost:3000" : (location.origin || "https://restaurant-management-wzhj.onrender.com");
      }
    })();
  </script>

  <script>
  // ---- Helpers ----
  const mealName  = p => p?.nome ?? p?.strMeal ?? p?.name ?? "Piatto";
  const mealPrice = p => Number(p?.prezzo ?? p?.price ?? 0) || 0;
  const mealId    = p => p?.idmeals ?? p?.idMeal ?? p?.id ?? p?._id;
  const orderId   = o => o?.id ?? o?._id ?? "";
  const fmtMoney  = n => `‚Ç¨${Number(n||0).toFixed(2)}`;
  const fmtDate   = iso => { try { return new Date(iso).toLocaleString(); } catch { return ""; } };

  // stati chiusi (solo ritiro)
  const isClosedStatus = s => ["ritirato","annullato"].includes(String(s||"").toLowerCase());
  const badgeClass = s => `badge ${String(s||"").toLowerCase()}`;

  document.addEventListener("DOMContentLoaded", initOrdini);

  async function initOrdini(){
    const user = JSON.parse(localStorage.getItem("loggedUser"));
    if (!user || user.role !== "cliente") {
      alert("Accesso riservato ai clienti");
      location.href = "login.html";
      return;
    }

    const container = document.getElementById("ordini-container");
    const noti = document.getElementById("noti");

    try {
      // 1) ordini del cliente
      const res = await fetch(`${API_BASE}/orders?` + new URLSearchParams({ username: user.username }), {
        headers: { "Accept": "application/json" }
      });
      if (!res.ok) throw new Error(`Orders HTTP ${res.status}`);
      const ordini = await res.json();

      // 2) catalogo piatti
      const menuRes = await fetch(`${API_BASE}/meals`, { headers: { "Accept": "application/json" }});
      if (!menuRes.ok) throw new Error(`Meals HTTP ${menuRes.status}`);
      const ristoranti = await menuRes.json();
      const tuttiIPiatti = Array.isArray(ristoranti)
        ? ristoranti.flatMap(r => Array.isArray(r?.menu) ? r.menu : [])
        : [];

      // solo ordini NON chiusi in questa pagina
      const attivi = (Array.isArray(ordini) ? ordini : [])
        .filter(o => !isClosedStatus(o?.status ?? o?.state));

      if (attivi.length === 0) {
        container.innerHTML = `
          <p>Nessun ordine attivo.</p>
          <p class="muted">Trovi gli ordini ritirati nello <a href="storico_clienti.html">storico clienti</a>.</p>`;
        return;
      }

      container.innerHTML = "";
      // mostro i pi√π recenti in alto
      [...attivi].sort((a,b) => new Date(b.createdAt||0) - new Date(a.createdAt||0))
      .forEach(ordine => {
        const div = document.createElement("div");
        div.className = "ordine-box";

        // preferisci snapshot items se presente
        let elenco = "-";
        if (Array.isArray(ordine.items) && ordine.items.length) {
          elenco = ordine.items
            .map(it => `${it.name ?? "Piatto"} x${it.qty || 1} (${fmtMoney(it.price || 0)})`)
            .join(", ");
        } else {
          elenco = (ordine?.meals ?? []).map(id => {
            const p = tuttiIPiatti.find(m => String(mealId(m)) == String(id));
            return p ? `${mealName(p)} (${fmtMoney(mealPrice(p))})` : `Piatto ID ${id}`;
          }).join(", ");
        }

        const idOrd = orderId(ordine);
        const stato = (ordine?.status ?? ordine?.state ?? "sconosciuto");

        div.innerHTML = `
          <p><strong>ID:</strong> ${idOrd || "<span class='muted'>(n/d)</span>"}</p>
          <p><strong>Creato:</strong> ${ordine?.createdAt ? fmtDate(ordine.createdAt) : "<span class='muted'>n/d</span>"}</p>
          <p><strong>Modalit√†:</strong> ritiro in negozio</p>
          <p><strong>Stato:</strong> <span class="stato ${badgeClass(stato)}">${stato}</span></p>
          <p><strong>Piatti:</strong> ${elenco || "-"}</p>
          <p><strong>Totale:</strong> ${fmtMoney(ordine?.total)}</p>
          <div class="azioni"></div>
        `;

        const azioniDiv = div.querySelector(".azioni");

        // bottone "Ho ritirato l'ordine"
        if (idOrd && !isClosedStatus(stato)) {
          const btnPick = document.createElement("button");
          btnPick.textContent = "Ho ritirato l'ordine";
          btnPick.addEventListener("click", async () => {
            const ok = confirm("Confermi di aver ritirato l'ordine al banco?");
            if (!ok) return;
            try {
              // alias endpoint compatibile con backend
              const putRes = await fetch(`${API_BASE}/orders/${encodeURIComponent(idOrd)}/state`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ newState: "ritirato", clienteConfermaRitiro: true })
              });
              if (!putRes.ok) {
                const detail = await putRes.json().catch(()=>({}));
                throw new Error(`PUT ${putRes.status} ${detail?.error||""}`);
              }

              // UI: rimuovo la card e notifico
              div.remove();
              noti.innerHTML = `
                <p class="success">‚úÖ Ritiro confermato. L'ordine √® stato spostato nello
                <a href="storico_clienti.html"><strong>storico clienti</strong></a>.</p>`;

              // Se non rimangono ordini attivi, mostra il messaggio vuoto
              if (!container.querySelector(".ordine-box")) {
                container.innerHTML = `
                  <p>Nessun ordine attivo.</p>
                  <p class="muted">Trovi gli ordini ritirati nello <a href="storico_clienti.html">storico clienti</a>.</p>`;
              }
            } catch (err) {
              console.error("Errore conferma ritiro:", err);
              alert("Errore nel confermare il ritiro.");
            }
          });
          azioniDiv.appendChild(btnPick);
        }

        container.appendChild(div);
      });
    } catch (err) {
      console.error("Errore caricamento ordini:", err);
      container.innerHTML = `
        <p style="color:#b00">Errore nel caricamento degli ordini.</p>
        <details><summary>Dettagli</summary><pre>${String(err)}</pre></details>
        <p>Verifica che <code>${API_BASE}/orders</code> e <code>${API_BASE}/meals</code> siano raggiungibili.</p>
      `;
    }
  }
  </script>
</body>
</html>

