<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My orders</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" type="image/png" href="images/logo.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>My orders</h1>

  <div id="summary" class="ordine-box" style="margin-bottom:16px;">
    <p class="muted">Loading...</p>
  </div>

  <div id="noti"></div>

  <div id="orders-container">
    <p>Loading...</p>
  </div>

  <p><a href="index.html">Return to the homepage</a></p>
  <p><a href="storico_clienti.html">Order history</a></p>

  <script src="js/main.js" defer></script>

  <script>
  // ---------- api_base ----------
  (function () {
    if (!window.API_BASE) {
      const isLocal = ["localhost","127.0.0.1"].includes(location.hostname);
      window.API_BASE = isLocal
        ? "http://localhost:3000"
        : (location.origin || "https://restaurant-management-wzhj.onrender.com");
    }
  })();

  // ---------------- helpers ----------------
  const mealName  = p => p?.nome ?? p?.strMeal ?? p?.name ?? "Dish";
  const mealPrice = p => Number(p?.prezzo ?? p?.price ?? 0) || 0;
  const mealId    = p => p?.idmeals ?? p?.idMeal ?? p?.id ?? p?._id;
  const orderId   = o => o?.id ?? o?._id ?? "";
  const fmtMoney  = n => `€${Number(n||0).toFixed(2)}`;
  const fmtDate   = iso => { try { return new Date(iso).toLocaleString('en-GB'); } catch { return ""; } };

  const CLOSED_STATES = ["ritirato","consegnato","annullato","withdrawn","delivered","canceled","cancelled"];
  const isClosedStatus = s => CLOSED_STATES.includes(String(s||"").toLowerCase());

  const labelStatus = s => {
    const t = String(s||"").toLowerCase();
    const map = {
      ordinato: "Ordered",
      preparazione: "Preparing",
      consegna: "Ready for pickup",
      consegnato: "Delivered",
      ritirato: "Picked up",
      annullato: "Canceled",
      withdrawn: "Picked up",
      delivered: "Delivered",
      canceled: "Canceled",
      cancelled: "Canceled"
    };
    return map[t] || (s || "Unknown");
  };

  const badgeClass = s => `badge ${String(s||"").toLowerCase()}`;

  // --- Build ID -> {nome, prezzo} da /meals
  function buildMealsMap(raw) {
    const map = new Map();
    const arr = Array.isArray(raw) ? raw : [];
    arr.forEach(node => {
      if (Array.isArray(node?.menu)) {
        node.menu.forEach(p => {
          map.set(String(mealId(p)), { name: mealName(p), price: mealPrice(p) });
        });
      } else {
        const p = node;
        if (p && (mealId(p) != null)) {
          map.set(String(mealId(p)), { name: mealName(p), price: mealPrice(p) });
        }
      }
    });
    return map;
  }

  // ------- item/id/qty helpers -------
  const getQty = it =>
    Number(it?.qty ?? it?.quantity ?? it?.quantita ?? it?.q ?? 1) || 1;

  const getItemId = it =>
    it?.mealId ?? it?.idmeal ?? it?.idmeals ?? it?.idMeal ?? it?.id ?? it?._id;

  const isNoName = s => {
    const t = String(s||"").trim().toLowerCase();
    return !t || t === "senza nome" || t === "unnamed" || t === "dish";
  };

  /**
   * Ritorno { listHtml, totale } usando:
   *  - order.items con  fallback a order.meals
   *  - riempie il nome/prezzo mancante dal catalogo
   */
  function renderItemsAndTotal(order, mealsMap) {
    let total = 0;
    let rows = [];

    if (Array.isArray(order.items) && order.items.length) {
      rows = order.items.map(it => {
        const id      = getItemId(it);
        const cat     = id ? mealsMap.get(String(id)) : null;

        let name = it.name ?? it.nome ?? "";
        if (isNoName(name)) name = cat?.name || (id ? `Dish #${id}` : "Dish");

        const qty   = getQty(it);
        const price = Number(it.prezzo ?? it.price ?? cat?.price ?? 0) || 0;

        total += price * qty;
        return `<li>${name} &times;${qty} — ${fmtMoney(price)} each → ${fmtMoney(price * qty)}</li>`;
      });
    } else if (Array.isArray(order.meals) && order.meals.length) {
      rows = order.meals.map(m => {
        const id  = (typeof m === "object") ? getItemId(m) : m;
        const qty = (typeof m === "object") ? getQty(m) : 1;
        const cat = id != null ? mealsMap.get(String(id)) : null;

        const name  = cat?.name || `Dish #${id ?? "?"}`;
        const price = Number(cat?.price ?? 0) || 0;

        total += price * qty;
        return `<li>${name} &times;${qty} — ${fmtMoney(price)} each → ${fmtMoney(price * qty)}</li>`;
      });
    } else {
      rows = [`<li class="muted">-</li>`];
      total = Number(order.total) || 0;
    }

    return { listHtml: rows.join(""), total };
  }

  // eta helpers
  function minutesLabel(ms) {
    const m = Math.ceil(ms/60000);
    if (m <= 1) return "≈ 1 min";
    if (m <= 5) return "≈ 5 min";
    if (m <= 10) return "≈ 10 min";
    return `≈ ${m} min`;
  }

  function getETA(ord) {
    const now = Date.now();
    const state = String(ord?.status ?? ord?.state ?? "").toLowerCase();

    const readyAtISO = ord.readyAt || ord.etaReadyAt || ord.estimatedReadyAt;
    if (readyAtISO) {
      const ra = new Date(readyAtISO).getTime();
      const rem = Math.max(0, ra - now);
      return { readyAt: new Date(ra), remainingMs: rem, label: rem === 0 ? "Ready for pickup" : minutesLabel(rem) };
    }

    const mins = Number(ord.prepMinutes || ord.etaMinutes);
    if (!Number.isNaN(mins) && mins > 0) {
      const ra = (new Date(ord.createdAt || Date.now())).getTime() + mins*60000;
      const rem = Math.max(0, ra - now);
      return { readyAt: new Date(ra), remainingMs: rem, label: rem === 0 ? "Ready for pickup" : minutesLabel(rem) };
    }

    if (state === "consegna") return { readyAt: new Date(), remainingMs: 0, label: "Ready for pickup" };
    const base = (state === "preparazione") ? 10 : 20;
    const ra = (new Date(ord.createdAt || Date.now())).getTime() + base*60000;
    const rem = Math.max(0, ra - now);
    return { readyAt: new Date(ra), remainingMs: rem, label: rem === 0 ? "Ready for pickup" : minutesLabel(rem) };
  }

  function startCountdown(span, order) {
    const tick = () => {
      const eta = getETA(order);
      span.textContent = eta.label;
      span.className = "eta " + (eta.remainingMs === 0 ? "done" : eta.remainingMs <= 10*60000 ? "soon" : "wait");
    };
    tick();
    const id = setInterval(() => {
      if (!span.isConnected) return clearInterval(id);
      tick();
    }, 15000);
  }

  document.addEventListener("DOMContentLoaded", initOrders);

  async function initOrders(){
    const user = JSON.parse(localStorage.getItem("loggedUser"));
    if (!user || user.role !== "cliente") {
      alert("Access reserved for customers");
      location.href = "login.html";
      return;
    }

    const container = document.getElementById("orders-container");
    const summary   = document.getElementById("summary");
    const noti      = document.getElementById("noti");

    try {
      // 1) ordine cliente
      const res = await fetch(`${API_BASE}/orders?` + new URLSearchParams({ username: user.username }), {
        headers: { "Accept": "application/json" }
      });
      if (!res.ok) throw new Error(`Orders HTTP ${res.status}`);
      const orders = await res.json();

      // 2) piatto  categoria
      const menuRes = await fetch(`${API_BASE}/meals`, { headers: { "Accept": "application/json" }});
      if (!menuRes.ok) throw new Error(`Meals HTTP ${menuRes.status}`);
      const restaurants = await menuRes.json();
      const mealsMap = buildMealsMap(restaurants);

      const all = Array.isArray(orders) ? orders : [];

      // --- totale---
      let totalSpent = 0, activeTotal = 0, activeCount = 0;
      for (const o of all) {
        const { total } = renderItemsAndTotal(o, mealsMap);
        totalSpent += total;
        const st = o?.status ?? o?.state;
        if (!isClosedStatus(st)) { activeTotal += total; activeCount++; }
      }
      const ordWord = activeCount === 1 ? "active order" : "active orders";
      summary.innerHTML = `
        <p><strong>Total spent (all orders):</strong> ${fmtMoney(totalSpent)}</p>
        <p><strong>Active total:</strong> ${fmtMoney(activeTotal)} — ${activeCount} ${ordWord}</p>
      `;

      // --- lista degli ordini attivi ---
      const active = all.filter(o => !isClosedStatus(o?.status ?? o?.state));

      if (active.length === 0) {
        container.innerHTML = `
          <p>No active orders.</p>
          <p class="muted">You can find picked-up/cancelled orders in the <a href="storico_clienti.html">order history</a>.</p>`;
        return;
      }

      container.innerHTML = "";
      [...active].sort((a,b) => new Date(b.createdAt||0) - new Date(a.createdAt||0))
      .forEach(order => {
        const div = document.createElement("div");
        div.className = "ordine-box";

        const { listHtml, total } = renderItemsAndTotal(order, mealsMap);
        const idOrd   = orderId(order);
        const rawSt   = (order?.status ?? order?.state ?? "Unknown");
        const stLabel = labelStatus(rawSt);
        const etaInfo = getETA(order);

        div.innerHTML = `
          <p class="rig"><strong>ID:</strong> ${idOrd || "<span class='muted'>(n/a)</span>"} </p>
          <p class="rig"><strong>Created:</strong> ${order?.createdAt ? fmtDate(order.createdAt) : "<span class='muted'>n/a</span>"}</p>
          <p class="rig"><strong>Mode:</strong> Pick up in store</p>
          <p class="rig"><strong>Status:</strong> <span class="stato ${badgeClass(rawSt)}">${stLabel}</span></p>
          <p class="rig"><strong>Estimated time:</strong> <span class="eta">${etaInfo.label}</span></p>
          <p class="rig"><strong>Dishes:</strong></p>
          <ul class="dishes">${listHtml}</ul>
          <p class="rig"><strong>Order total:</strong> ${fmtMoney(total)}</p>
          <div class="actions"></div>
        `;

        startCountdown(div.querySelector(".eta"), order);

        // "ho ritirato ordine" bottone
        const actions = div.querySelector(".actions");
        if (idOrd && !isClosedStatus(rawSt)) {
          const btnPick = document.createElement("button");
          btnPick.textContent = "I picked up the order";
          btnPick.addEventListener("click", async () => {
            const ok = confirm("Are you sure you picked up your order at the counter?");
            if (!ok) return;
            try {
              const putRes = await fetch(`${API_BASE}/orders/${encodeURIComponent(idOrd)}/state`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ newState: "ritirato", clienteConfermaRitiro: true })
              });
              if (!putRes.ok) {
                const detail = await putRes.json().catch(()=>({}));
                throw new Error(`PUT ${putRes.status} ${detail?.error || ""}`);
              }
              div.remove();
              noti.innerHTML = `<p class="success">Pickup confirmed. The order has been moved to the <a href="storico_clienti.html"><strong>order history</strong></a>.</p>`;
              if (!container.querySelector(".ordine-box")) {
                container.innerHTML = `
                  <p>No active orders.</p>
                  <p class="muted">You can find picked-up orders in the <a href="storico_clienti.html">order history</a>.</p>`;
              }
              // ricarica riepilogo
              initOrders();
            } catch (err) {
              console.error("Pickup confirmation error:", err);
              alert("Error confirming pickup.");
            }
          });
          actions.appendChild(btnPick);
        }

        container.appendChild(div);
      });
    } catch (err) {
      console.error("Error loading orders:", err);
      document.getElementById("orders-container").innerHTML = `
        <p style="color:#b00">Error loading orders.</p>
        <details><summary>Details</summary><pre>${String(err)}</pre></details>
        <p>Check that <code>${API_BASE}/orders</code> and <code>${API_BASE}/meals</code> are reachable.</p>`;
    }
  }
  </script>
</body>
</html>
