<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>I miei ordini</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .ordine-box { border:1px solid #ddd; border-radius:10px; padding:12px; margin:10px 0; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:.85rem; }
    .badge.ordinato{ background:#eef; }
    .badge.preparazione{ background:#ffe9b3; }
    .badge.ritirato{ background:#c7f9cc; }
    .badge.annullato{ background:#ffd6d6; }
    .azioni button{ margin-right:8px; }
    .muted { color:#666; }
  </style>
</head>
<body>
  <h1>üì¶ I miei ordini</h1>

  <div id="ordini-container">
    <p>Caricamento in corso...</p>
  </div>

  <p><a href="index.html">‚¨ÖÔ∏è Torna alla home</a></p>
  <p><a href="storico_clienti.html">vecchi ordini</a></p>

  <!-- Se lo usi altrove, lascialo pure -->
  <script src="js/main.js" defer></script>

  <!-- Fallback API_BASE -->
  <script>
    (function () {
      if (!window.API_BASE) {
        const isLocal = ["localhost","127.0.0.1"].includes(location.hostname);
        window.API_BASE = isLocal ? "http://localhost:3000" : (location.origin || "https://restaurant-management-wzhj.onrender.com");
      }
    })();
  </script>

  <script>
  // Helpers
  const mealName  = p => p?.nome ?? p?.strMeal ?? p?.name ?? "Piatto";
  const mealPrice = p => Number(p?.prezzo ?? p?.price ?? 0) || 0;
  const mealId    = p => p?.idmeals ?? p?.idMeal ?? p?.id ?? p?._id;
  const orderId   = o => o?.id ?? o?._id ?? "";
  const fmtMoney  = n => `‚Ç¨${Number(n||0).toFixed(2)}`;
  const fmtDate   = iso => { try { return new Date(iso).toLocaleString(); } catch { return ""; } };

  // Solo ritiro: stati finali
  const isClosedStatus = s => ["ritirato","annullato"].includes(String(s||"").toLowerCase());
  const badgeClass = s => `badge ${String(s||"").toLowerCase()}`;

  document.addEventListener("DOMContentLoaded", initOrdini);

  async function initOrdini(){
    const user = JSON.parse(localStorage.getItem("loggedUser"));
    if (!user || user.role !== "cliente") {
      alert("Accesso riservato ai clienti");
      location.href = "login.html";
      return;
    }

    const container = document.getElementById("ordini-container");

    try {
      // 1) ordini del cliente
      const qs = new URLSearchParams({ username: user.username });
      const res = await fetch(`${API_BASE}/orders?${qs.toString()}`, { headers: { "Accept": "application/json" }});
      if (!res.ok) throw new Error(`Orders HTTP ${res.status}`);
      const ordini = await res.json();

      // 2) catalogo piatti (per nomi/prezzi)
      const menuRes = await fetch(`${API_BASE}/meals`, { headers: { "Accept": "application/json" }});
      if (!menuRes.ok) throw new Error(`Meals HTTP ${menuRes.status}`);
      const ristoranti = await menuRes.json();
      const tuttiIPiatti = Array.isArray(ristoranti) ? ristoranti.flatMap(r => Array.isArray(r?.menu) ? r.menu : []) : [];

      if (!Array.isArray(ordini) || ordini.length === 0) {
        container.innerHTML = "<p>Nessun ordine trovato.</p>";
        return;
      }

      container.innerHTML = "";
      [...ordini].reverse().forEach(ordine => {
        const div = document.createElement("div");
        div.className = "ordine-box";

        const elenco = (ordine?.meals ?? []).map(id => {
          const p = tuttiIPiatti.find(m => String(mealId(m)) == String(id));
          return p ? `${mealName(p)} (${fmtMoney(mealPrice(p))})` : `Piatto ID ${id}`;
        }).join(", ");

        const idOrd   = orderId(ordine);
        const stato   = ordine?.status ?? "sconosciuto";

        div.innerHTML = `
          <p><strong>ID:</strong> ${idOrd || "<span class='muted'>(n/d)</span>"}</p>
          <p><strong>Creato:</strong> ${ordine?.createdAt ? fmtDate(ordine.createdAt) : "<span class='muted'>n/d</span>"}</p>
          <p><strong>Modalit√†:</strong> ritiro in negozio</p>
          <p><strong>Stato:</strong> <span class="stato ${badgeClass(stato)}">${stato}</span></p>
          <p><strong>Piatti:</strong> ${elenco || "-"}</p>
          <p><strong>Totale:</strong> ${fmtMoney(ordine?.total)}</p>
          <div class="azioni"></div>
        `;

        const azioniDiv = div.querySelector(".azioni");

        // Se l‚Äôordine non √® chiuso, mostra il pulsante "Ho ritirato l'ordine"
        if (idOrd && !isClosedStatus(stato)) {
          const btnPick = document.createElement("button");
          btnPick.textContent = "Ho ritirato l'ordine";
          btnPick.addEventListener("click", async () => {
            const ok = confirm("Confermi di aver ritirato l'ordine al banco?");
            if (!ok) return;
            try {
              const putRes = await fetch(`${API_BASE}/orders/${encodeURIComponent(idOrd)}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: "ritirato", clienteConfermaRitiro: true })
              });
              if (!putRes.ok) {
                const detail = await putRes.json().catch(()=>({}));
                throw new Error(`PUT ${putRes.status} ${detail?.error||""}`);
              }
              const badge = div.querySelector(".stato");
              badge.textContent = "ritirato";
              badge.className = `stato ${badgeClass("ritirato")}`;
              btnPick.disabled = true;
              btnPick.textContent = "Ritiro confermato ‚úÖ";
            } catch (err) {
              console.error("Errore conferma ritiro:", err);
              alert("Errore nel confermare il ritiro.");
            }
          });
          azioniDiv.appendChild(btnPick);
        }

        container.appendChild(div);
      });
    } catch (err) {
      console.error("Errore caricamento ordini:", err);
      container.innerHTML = `
        <p style="color:#b00">Errore nel caricamento degli ordini.</p>
        <details><summary>Dettagli</summary><pre>${String(err)}</pre></details>
        <p>Verifica che <code>${API_BASE}/orders</code> e <code>${API_BASE}/meals</code> siano raggiungibili.</p>
      `;
    }
  }
  </script>
</body>
</html>

