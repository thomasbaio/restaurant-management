<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>I miei ordini</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <h1>üì¶ I miei ordini</h1>

  <div id="ordini-container">
    <p>Caricamento in corso...</p>
  </div>

  <p><a href="index.html">‚¨ÖÔ∏è Torna alla home</a></p>
  <p><a href="storico_clienti.html">vecchi ordini</a></p>

  <!-- ‚úÖ CORREGGI QUI IL PATH se serve: js/main.js oppure main.js -->
  <script src="js/main.js" defer></script>

  <!-- Fallback nel caso main.js non carichi -->
  <script>
    (function () {
      if (!window.API_BASE) {
        const isLocal = ["localhost","127.0.0.1"].includes(location.hostname);
        window.API_BASE = isLocal
          ? "http://localhost:3000"
          : (location.origin || "https://restaurant-management-wzhj.onrender.com");
      }
    })();
  </script>

  <script>
  function mealName(p){ return p?.nome ?? p?.strMeal ?? p?.name ?? "Piatto"; }
  function mealPrice(p){ const n=Number(p?.prezzo ?? p?.price ?? 0); return Number.isFinite(n)?n:0; }
  function mealId(p){ return p?.idmeals ?? p?.idMeal ?? p?.id ?? p?._id; }
  function orderId(o){ return o?.id ?? o?._id ?? ""; }

  // ‚ûï Helper: riconosciamo i tipi di ritiro
  function isPickupType(delivery) {
    const d = String(delivery || "").toLowerCase();
    return d.includes("asporto") || d.includes("ritiro") || d.includes("pickup");
  }

  // ‚ûï Helper: ordine gi√† chiuso?
  function isClosedStatus(status) {
    const s = String(status || "").toLowerCase();
    return ["consegnato","annullato","ritirato"].includes(s);
  }

  window.onload = async () => {
    const user = JSON.parse(localStorage.getItem("loggedUser"));
    if (!user || user.role !== "cliente") {
      alert("Accesso riservato ai clienti");
      window.location.href = "login.html";
      return;
    }

    const container = document.getElementById("ordini-container");

    try {
      // 1) ORDINI
      const qs = new URLSearchParams({ username: user.username });
      const res = await fetch(`${API_BASE}/orders?${qs.toString()}`, {
        headers: { "Accept": "application/json" },
      });
      if (!res.ok) throw new Error(`Orders HTTP ${res.status}`);
      const ordini = await res.json();

      // 2) MENU completo
      const menuRes = await fetch(`${API_BASE}/meals`, {
        headers: { "Accept": "application/json" },
      });
      if (!menuRes.ok) throw new Error(`Meals HTTP ${menuRes.status}`);
      const ristoranti = await menuRes.json();
      const tuttiIPiatti = Array.isArray(ristoranti)
        ? ristoranti.flatMap(r => Array.isArray(r?.menu) ? r.menu : [])
        : [];

      if (!Array.isArray(ordini) || ordini.length === 0) {
        container.innerHTML = "<p>Nessun ordine trovato.</p>";
        return;
      }

      container.innerHTML = "";
      [...ordini].reverse().forEach(ordine => {
        const div = document.createElement("div");
        div.className = "ordine-box";

        const piattiOrdinati = (ordine?.meals ?? []).map(id => {
          const p = tuttiIPiatti.find(m => String(mealId(m)) == String(id));
          return p
            ? `${mealName(p)} (‚Ç¨${mealPrice(p).toFixed(2)})`
            : `Piatto ID ${id}`;
        }).join(", ");

        const idOrd = orderId(ordine);
        const stato = ordine?.status ?? "sconosciuto";
        const consegna = ordine?.delivery ?? "-";

        div.innerHTML = `
          <p><strong>ID:</strong> ${idOrd}</p>
          <p><strong>Consegna:</strong> ${consegna}</p>
          <p><strong>Stato:</strong> <span class="stato">${stato}</span></p>
          <p><strong>Piatti:</strong> ${piattiOrdinati || "-"}</p>
          ${String(consegna).toLowerCase()==="domicilio" ? `<p><strong>Indirizzo:</strong> ${ordine?.address ?? "-"}</p>` : ""}
          <div class="azioni"></div>
        `;

        const azioniDiv = div.querySelector(".azioni");

        // ‚úÖ Caso consegna a domicilio: conferma "Consegnato"
        if (!isClosedStatus(stato) && String(consegna).toLowerCase() === "domicilio") {
          const btn = document.createElement("button");
          btn.textContent = "Segnala come consegnato";
          btn.addEventListener("click", async () => {
            const ok = confirm("Confermi che l'ordine √® stato consegnato?");
            if (!ok) return;
            try {
              const putRes = await fetch(`${API_BASE}/orders/${encodeURIComponent(idOrd)}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: "consegnato" })
              });
              if (!putRes.ok) throw new Error(`PUT HTTP ${putRes.status}`);
              div.querySelector(".stato").textContent = "consegnato";
              btn.disabled = true;
              btn.textContent = "Consegnato ‚úÖ";
            } catch (err) {
              console.error("Errore aggiornamento ordine:", err);
              alert("Errore nel segnalare la consegna.");
            }
          });
          azioniDiv.appendChild(btn);
        }

        // ‚ûï Caso ritiro/asporto: conferma "Ritirato" (con fallback a "consegnato")
        if (!isClosedStatus(stato) && isPickupType(consegna)) {
          const btnPick = document.createElement("button");
          btnPick.textContent = "Ho ritirato l'ordine";
          btnPick.addEventListener("click", async () => {
            const ok = confirm("Confermi di aver ritirato l'ordine al banco?");
            if (!ok) return;

            // Primo tentativo: stato 'ritirato'
            try {
              let putRes = await fetch(`${API_BASE}/orders/${encodeURIComponent(idOrd)}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: "ritirato", clienteConfermaRitiro: true })
              });

              // Se il backend non accetta 'ritirato', fallback a 'consegnato'
              if (!putRes.ok) {
                // 400/422 molto probabili se lo stato non √® ammesso
                putRes = await fetch(`${API_BASE}/orders/${encodeURIComponent(idOrd)}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ status: "consegnato", clienteConfermaRitiro: true })
                });
                if (!putRes.ok) throw new Error(`PUT fallback HTTP ${putRes.status}`);
                div.querySelector(".stato").textContent = "consegnato";
                btnPick.disabled = true;
                btnPick.textContent = "Ritiro confermato ‚úÖ";
                return;
              }

              // Caso in cui 'ritirato' √® supportato
              div.querySelector(".stato").textContent = "ritirato";
              btnPick.disabled = true;
              btnPick.textContent = "Ritiro confermato ‚úÖ";
            } catch (err) {
              console.error("Errore aggiornamento ritiro:", err);
              alert("Errore nel confermare il ritiro.");
            }
          });
          azioniDiv.appendChild(btnPick);
        }

        container.appendChild(div);
      });
    } catch (err) {
      console.error("Errore caricamento ordini:", err);
      container.innerHTML = `
        <p style="color:#b00">Errore nel caricamento degli ordini.</p>
        <details><summary>Dettagli</summary><pre>${String(err)}</pre></details>
        <p>Verifica che <code>${API_BASE}/orders</code> e <code>${API_BASE}/meals</code> siano raggiungibili.</p>
      `;
    }
  };
  </script>
</body>
</html>

