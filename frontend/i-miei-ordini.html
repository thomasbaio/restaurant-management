<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My orders</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <h1>My orders</h1>

  <div id="noti"></div>
  <div id="ordini-container">
    <p>Loading...</p>
  </div>

  <p><a href="index.html">Return to the homepage</a></p>
  <p><a href="storico_clienti.html">Order history</a></p>

  <script src="js/main.js" defer></script>

  <!-- Fallback API_BASE -->
  <script>
    (function () {
      if (!window.API_BASE) {
        const isLocal = ["localhost","127.0.0.1"].includes(location.hostname);
        window.API_BASE = isLocal
          ? "http://localhost:3000"
          : (location.origin || "https://restaurant-management-wzhj.onrender.com");
      }
    })();
  </script>

  <script>
  // ---- helpers ----
  const mealName  = p => p?.nome ?? p?.strMeal ?? p?.name ?? "Dish";
  const mealPrice = p => Number(p?.prezzo ?? p?.price ?? 0) || 0;
  const mealId    = p => p?.idmeals ?? p?.idMeal ?? p?.id ?? p?._id;
  const orderId   = o => o?.id ?? o?._id ?? "";
  const fmtMoney  = n => `â‚¬${Number(n||0).toFixed(2)}`;
  const fmtDate   = iso => { try { return new Date(iso).toLocaleString(); } catch { return ""; } };

  // stati chiusi (italiano + inglese)
  const CLOSED_STATES = [
    "ritirato","consegnato","annullato",
    "withdrawn","delivered","canceled","cancelled"
  ];
  const isClosedStatus = s => CLOSED_STATES.includes(String(s||"").toLowerCase());

  // etichetta in inglese per lo stato ricevuto dal server
  const labelStatus = s => {
    const t = String(s||"").toLowerCase();
    const map = {
      ordinato: "Ordered",
      preparazione: "Preparing",
      consegna: "Ready for pickup",
      consegnato: "Delivered",
      ritirato: "Picked up",
      annullato: "Canceled",
      withdrawn: "Picked up",
      delivered: "Delivered",
      canceled: "Canceled",
      cancelled: "Canceled"
    };
    return map[t] || (s || "Unknown");
  };

  const badgeClass = s => `badge ${String(s||"").toLowerCase()}`;

  document.addEventListener("DOMContentLoaded", initOrdini);

  async function initOrdini(){
    const user = JSON.parse(localStorage.getItem("loggedUser"));
    if (!user || user.role !== "cliente") {
      alert("Access reserved for customers");
      location.href = "login.html";
      return;
    }

    const container = document.getElementById("ordini-container");
    const noti = document.getElementById("noti");

    try {
      // 1) ordini del cliente
      const res = await fetch(`${API_BASE}/orders?` + new URLSearchParams({ username: user.username }), {
        headers: { "Accept": "application/json" }
      });
      if (!res.ok) throw new Error(`Orders HTTP ${res.status}`);
      const ordini = await res.json();

      // 2) catalogo piatti
      const menuRes = await fetch(`${API_BASE}/meals`, { headers: { "Accept": "application/json" }});
      if (!menuRes.ok) throw new Error(`Meals HTTP ${menuRes.status}`);
      const ristoranti = await menuRes.json();
      const tuttiIPiatti = Array.isArray(ristoranti)
        ? ristoranti.flatMap(r => Array.isArray(r?.menu) ? r.menu : [])
        : [];

      // solo ordini NON chiusi
      const attivi = (Array.isArray(ordini) ? ordini : [])
        .filter(o => !isClosedStatus(o?.status ?? o?.state));

      if (attivi.length === 0) {
        container.innerHTML = `
          <p>No active orders.</p>
          <p class="muted">You can find picked-up/cancelled orders in the <a href="storico_clienti.html">customer history</a>.</p>`;
        return;
      }

      container.innerHTML = "";
      [...attivi].sort((a,b) => new Date(b.createdAt||0) - new Date(a.createdAt||0))
      .forEach(ordine => {
        const div = document.createElement("div");
        div.className = "ordine-box";

        // preferisci snapshot items se presente
        let elenco = "-";
        if (Array.isArray(ordine.items) && ordine.items.length) {
          elenco = ordine.items
            .map(it => `${it.name ?? "Dish"} x${it.qty || 1} (${fmtMoney(it.price || 0)})`)
            .join(", ");
        } else {
          elenco = (ordine?.meals ?? []).map(id => {
            const p = tuttiIPiatti.find(m => String(mealId(m)) == String(id));
            return p ? `${mealName(p)} (${fmtMoney(mealPrice(p))})` : `Dish ID ${id}`;
          }).join(", ");
        }

        const idOrd = orderId(ordine);
        const statoRaw = (ordine?.status ?? ordine?.state ?? "Unknown");
        const statoLbl = labelStatus(statoRaw);

        div.innerHTML = `
          <p><strong>ID:</strong> ${idOrd || "<span class='muted'>(n/a)</span>"}</p>
          <p><strong>Created:</strong> ${ordine?.createdAt ? fmtDate(ordine.createdAt) : "<span class='muted'>n/a</span>"}</p>
          <p><strong>Mode:</strong> Pick up in store</p>
          <p><strong>Status:</strong> <span class="stato ${badgeClass(statoRaw)}">${statoLbl}</span></p>
          <p><strong>Dishes:</strong> ${elenco || "-"}</p>
          <p><strong>Total:</strong> ${fmtMoney(ordine?.total)}</p>
          <div class="azioni"></div>
        `;

        const azioniDiv = div.querySelector(".azioni");

        // bottone "Ho ritirato l'ordine"
        if (idOrd && !isClosedStatus(statoRaw)) {
          const btnPick = document.createElement("button");
          btnPick.textContent = "I picked up the order";
          btnPick.addEventListener("click", async () => {
            const ok = confirm("Are you sure you picked up your order at the counter?");
            if (!ok) return;
            try {
              // manda stato atteso dal backend (italiano)
              const putRes = await fetch(`${API_BASE}/orders/${encodeURIComponent(idOrd)}/state`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ newState: "ritirato", clienteConfermaRitiro: true })
              });
              if (!putRes.ok) {
                const detail = await putRes.json().catch(()=>({}));
                throw new Error(`PUT ${putRes.status} ${detail?.error || ""}`);
              }

              // ui: rimuovo la card e notifico
              div.remove();
              noti.innerHTML = `
                <p class="success">Pickup confirmed. The order has been moved to the
                <a href="storico_clienti.html"><strong>customer history</strong></a>.</p>`;

              // se non rimangono ordini attivi, mostra messaggio vuoto
              if (!container.querySelector(".ordine-box")) {
                container.innerHTML = `
                  <p>No active orders.</p>
                  <p class="muted">You can find picked-up orders in the <a href="storico_clienti.html">customer history</a>.</p>`;
              }
            } catch (err) {
              console.error("Pickup confirmation error:", err);
              alert("Error confirming pickup.");
            }
          });
          azioniDiv.appendChild(btnPick);
        }

        container.appendChild(div);
      });
    } catch (err) {
      console.error("Error loading orders:", err);
      container.innerHTML = `
        <p style="color:#b00">Error loading orders.</p>
        <details><summary>Details</summary><pre>${String(err)}</pre></details>
        <p>Check that <code>${API_BASE}/orders</code> and <code>${API_BASE}/meals</code> are reachable.</p>
      `;
    }
  }
  </script>
</body>
</html>
