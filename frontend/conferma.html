<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Confirm Order</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <h1>Order Confirmed</h1>
  <h2>Thank you for choosing us!</h2>

  <div id="riepilogo" class="box"></div>

  <h3>Ordered dishes:</h3>
  <ul id="lista-piatti" class="box"></ul>

  <p><a href="index.html">Return to the homepage</a></p>

<script>
window.onload = async () => {
  const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
  const API_BASE = isLocal
    ? "http://localhost:3000"
    : "https://restaurant-management-wzhj.onrender.com";

  const riepilogo   = document.getElementById("riepilogo");
  const listaPiatti = document.getElementById("lista-piatti");

  // --- Helpers ---
  const toStr = (v) => (v == null ? null : String(v));
  const clean = (s) => (typeof s === "string" ? s.trim().toLowerCase() : null);

  function normalizeMealDB(p) {
    const id = toStr(p.idmeals ?? p.idMeal ?? p.id ?? p._id);
    const nome = p.nome ?? p.strMeal ?? p.name ?? "No name";
    const prezzo = Number(p.prezzo ?? p.price ?? 0) || 0;
    return { id, nome, prezzo };
  }

  // Estrae elementi ordine in formato {id?, nome?, prezzo?, qty}
  function extractOrderItems(raw) {
    const arr = Array.isArray(raw) ? raw : [];
    return arr.map(x => {
      if (typeof x === "string" || typeof x === "number") {
        return { id: toStr(x), qty: 1 };
      }
      if (x && typeof x === "object") {
        const id = toStr(x.mealId ?? x.idmeals ?? x.idMeal ?? x.id ?? x._id);
        const nome = x.nome ?? x.strMeal ?? x.name ?? x.title ?? null;
        const prezzo = Number(x.prezzo ?? x.price);
        const qty = Number(x.qty ?? x.quantity ?? 1) || 1;
        return { id, nome, prezzo, qty };
      }
      return { qty: 0 };
    }).filter(it => it.id || it.nome);
  }

  function collapse(items) {
    // unisce quantità per stesso id/nome
    const agg = new Map();
    for (const it of items) {
      const key = it.id ? `id:${it.id}` : `name:${clean(it.nome)}`;
      const cur = agg.get(key) || { ...it, qty: 0 };
      cur.qty += it.qty || 1;
      agg.set(key, cur);
    }
    return [...agg.values()];
  }

  async function loadMealsCatalog() {
    const res = await fetch(`${API_BASE}/meals`, { mode: "cors" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const all = Array.isArray(data) ? data.flatMap(r => Array.isArray(r.menu) ? r.menu : []) : [];
    return all.map(normalizeMealDB);
  }

  function renderRiepilogo(ord) {
    const pagamento = ord.payment || "card";
    const consegna  = ord.delivery || "-";
    const indirizzo = ord.delivery === "domicilio" ? (ord.address || "-") : null;
    riepilogo.innerHTML = `
      <p><strong>Delivery:</strong> ${consegna}</p>
      <p><strong>Payment method:</strong> ${pagamento}</p>
      ${indirizzo ? `<p><strong>Address:</strong> ${indirizzo}</p>` : ""}
    `;
  }

  async function resolveAndRenderItems(orderItems) {
    // 1) Se hanno già i nomi
    if (orderItems.length && orderItems.every(it => !!it.nome)) {
      let totale = 0;
      listaPiatti.innerHTML = orderItems.map(it => {
        const prezzo = Number(it.prezzo ?? 0) || 0;
        const subtot = prezzo * (it.qty || 1);
        totale += subtot;
        const prezzoTxt = prezzo ? ` — €${subtot.toFixed(2)}` : "";
        return `<li><strong>${it.nome}</strong> × ${it.qty || 1}${prezzoTxt}</li>`;
      }).join("");
      if (totale > 0) {
        const totLi = document.createElement("li");
        totLi.style.marginTop = "8px";
        totLi.innerHTML = `<strong>Total:</strong> €${totale.toFixed(2)}`;
        listaPiatti.appendChild(totLi);
      }
      return;
    }

    // 2) Altrimenti cerco nel catalogo per id/nome
    const catalogo = await loadMealsCatalog();
    const byId   = new Map(catalogo.filter(m => m.id).map(m => [m.id, m]));
    const byName = new Map(catalogo.map(m => [clean(m.nome), m]));

    const itemsCollassati = collapse(orderItems);
    const righe = [];
    let totale = 0;

    for (const it of itemsCollassati) {
      let meal = null;
      if (it.id && byId.has(it.id)) meal = byId.get(it.id);
      else if (it.nome && byName.has(clean(it.nome))) meal = byName.get(clean(it.nome));

      if (meal) {
        const subtot = (meal.prezzo || 0) * it.qty;
        totale += subtot;
        righe.push(`<li><strong>${meal.nome}</strong> × ${it.qty} — €${subtot.toFixed(2)}</li>`);
      }
    }

    if (righe.length === 0) {
      listaPiatti.innerHTML = `<li>No dishes found.</li>`;
    } else {
      listaPiatti.innerHTML = righe.join("");
      const totLi = document.createElement("li");
      totLi.style.marginTop = "8px";
      totLi.innerHTML = `<strong>Total:</strong> €${totale.toFixed(2)}`;
      listaPiatti.appendChild(totLi);
    }
  }

  // --- 1) Provo dal localStorage
  let ordine = JSON.parse(localStorage.getItem("lastConfirmedOrder")) || {};
  let items =
    extractOrderItems(ordine.meals)
      .concat(extractOrderItems(ordine.items))
      .concat(extractOrderItems(ordine.cart))
      .concat(extractOrderItems(ordine.cartItems));

  // --- 2) Se non ho items, recupero l'ULTIMO ordine del cliente dal backend
  if (!items.length) {
    try {
      const user = JSON.parse(localStorage.getItem("loggedUser"));
      if (user?.username) {
        const res = await fetch(`${API_BASE}/orders?username=${encodeURIComponent(user.username)}`, { mode: "cors" });
        if (res.ok) {
          const lista = await res.json();
          // prendo il più recente (per id crescente o createdAt)
          const last = (lista || []).sort((a, b) => {
            const ia = Number(a.id || 0), ib = Number(b.id || 0);
            if (ia !== ib) return ib - ia;
            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
          })[0];

          if (last) {
            ordine = Object.assign({}, last, ordine); // tengo eventuali campi utili
            items =
              extractOrderItems(last.meals)
                .concat(extractOrderItems(last.items))
                .concat(extractOrderItems(last.cart))
                .concat(extractOrderItems(last.cartItems));
          }
        }
      }
    } catch (e) {
      console.warn("Unable to retrieve last order from backend:", e);
    }
  }

  // --- Render riepilogo e lista
  renderRiepilogo(ordine);

  if (!items.length) {
    listaPiatti.innerHTML = "<li>No dishes found.</li>";
  } else {
    try {
      await resolveAndRenderItems(items);
    } catch (e) {
      console.error(e);
      listaPiatti.innerHTML = "<li class='err'>Error loading dishes.</li>";
    }
  }

</script>

</body>
</html>
